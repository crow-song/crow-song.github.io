<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222"/>




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2"/>



















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0"/>

<link rel="stylesheet" href="/css/main.css?v=7.2.0"/>


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="BOS 项目 定区关联客户在 BOS 中配置代理对象远程调用 crm完善 CRM 中的客户查询方法（增加未关联定区的客户，和已关联定区的客户） 更新 BOS 中的 ICustomerService（重新使用 wsimport -s . -p com.itheima.crm http://192.168.171.1:8080/service/customer?wsdl 下载代码，对程序中代码进行覆盖">
<meta name="keywords" content="java,web,ssh">
<meta property="og:type" content="article">
<meta property="og:title" content="BOS_later">
<meta property="og:url" content="http://yoursite.com/2019/02/21/BOS-later/index.html">
<meta property="og:site_name" content="crowsongのblog">
<meta property="og:description" content="BOS 项目 定区关联客户在 BOS 中配置代理对象远程调用 crm完善 CRM 中的客户查询方法（增加未关联定区的客户，和已关联定区的客户） 更新 BOS 中的 ICustomerService（重新使用 wsimport -s . -p com.itheima.crm http://192.168.171.1:8080/service/customer?wsdl 下载代码，对程序中代码进行覆盖">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="d:/hexo/source/_posts/BOS-later/%5CUsers%5CZHIEND%5CDesktop%5C%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B.png">
<meta property="og:updated_time" content="2019-06-12T02:35:53.502Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="BOS_later">
<meta name="twitter:description" content="BOS 项目 定区关联客户在 BOS 中配置代理对象远程调用 crm完善 CRM 中的客户查询方法（增加未关联定区的客户，和已关联定区的客户） 更新 BOS 中的 ICustomerService（重新使用 wsimport -s . -p com.itheima.crm http://192.168.171.1:8080/service/customer?wsdl 下载代码，对程序中代码进行覆盖">
<meta name="twitter:image" content="d:/hexo/source/_posts/BOS-later/%5CUsers%5CZHIEND%5CDesktop%5C%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B.png">



  <link rel="alternate" href="/atom.xml" title="crowsongのblog" type="application/atom+xml"/>



  
  
  <link rel="canonical" href="http://yoursite.com/2019/02/21/BOS-later/"/>



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>BOS_later | crowsongのblog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">crowsongのblog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br/>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br/>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br/>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br/>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br/>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br/>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/21/BOS-later/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="crowsong"/>
      <meta itemprop="description" content="日々私たちが过ごしている日常は、実は、奇迹の连続なのかもしれない"/>
      <meta itemprop="image" content="/images/shuvi.gif"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="crowsongのblog"/>
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">BOS_later

              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-02-21 21:35:58" itemprop="dateCreated datePublished" datetime="2019-02-21T21:35:58+08:00">2019-02-21</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-06-12 10:35:53" itemprop="dateModified" datetime="2019-06-12T10:35:53+08:00">2019-06-12</time>
              </span>
            
          

          

          
            
            
          

          
          

          

          <br/>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>BOS 项目</p>
<h4 id="定区关联客户"><a href="#定区关联客户" class="headerlink" title="定区关联客户"></a>定区关联客户</h4><h5 id="在-BOS-中配置代理对象远程调用-crm"><a href="#在-BOS-中配置代理对象远程调用-crm" class="headerlink" title="在 BOS 中配置代理对象远程调用 crm"></a>在 BOS 中配置代理对象远程调用 crm</h5><p>完善 CRM 中的客户查询方法（增加未关联定区的客户，和已关联定区的客户）</p>
<p>更新 BOS 中的 ICustomerService（重新使用 wsimport -s . -p com.itheima.crm <a href="http://192.168.171.1:8080/service/customer?wsdl" target="_blank" rel="noopener">http://192.168.171.1:8080/service/customer?wsdl</a> 下载代码，对程序中代码进行覆盖）</p>
<p>在 BOS 项目中配置代理对象，远程调用 crm 服务</p>
<a id="more"></a>
<ul>
<li><p>在 pom 文件中引入 cxf jar 包</p>
</li>
<li><p>使用 wsimport 命令解析 wsdl 文件生成本地代码，只保留接口文件 ICustomerService 和 Customer bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.crm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.crm.service.Customer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jws.WebMethod;</span><br><span class="line"><span class="keyword">import</span> javax.jws.WebResult;</span><br><span class="line"><span class="keyword">import</span> javax.jws.WebService;</span><br><span class="line"><span class="keyword">import</span> javax.xml.bind.annotation.XmlSeeAlso;</span><br><span class="line"><span class="keyword">import</span> javax.xml.ws.RequestWrapper;</span><br><span class="line"><span class="keyword">import</span> javax.xml.ws.ResponseWrapper;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This class was generated by the JAX-WS RI.</span></span><br><span class="line"><span class="comment"> * JAX-WS RI 2.2.9-b130926.1035</span></span><br><span class="line"><span class="comment"> * Generated source version: 2.2</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebService</span>(name = <span class="string">"ICustomerService"</span>, targetNamespace = <span class="string">"http://service.crm.itheima.com/"</span>)</span><br><span class="line"><span class="meta">@XmlSeeAlso</span>(&#123;</span><br><span class="line">        <span class="comment">//ObjectFactory.class</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ICustomerService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     *     returns java.util.List&lt;com.itheima.crm.service.Customer&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@WebMethod</span></span><br><span class="line">    <span class="meta">@WebResult</span>(targetNamespace = <span class="string">""</span>)</span><br><span class="line">    <span class="meta">@RequestWrapper</span>(localName = <span class="string">"findAll"</span>, targetNamespace = <span class="string">"http://service.crm.itheima.com/"</span>, className = <span class="string">"com.itheima.crm.service.FindAll"</span>)</span><br><span class="line">    <span class="meta">@ResponseWrapper</span>(localName = <span class="string">"findAllResponse"</span>, targetNamespace = <span class="string">"http://service.crm.itheima.com/"</span>, className = <span class="string">"com.itheima.crm.service.FindAllResponse"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Customer&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 spring 配置文件注册 crm 客户端代理对象</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--注册 crm 客户端代理对象 192.168.171.1--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jaxws:client</span> <span class="attr">id</span>=<span class="string">"crmClient"</span> <span class="attr">serviceClass</span>=<span class="string">"com.itheima.crm.ICustomerService"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">address</span>=<span class="string">"http://192.168.171.1:8080/service/customer"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 action 中调用 crm 服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserAction</span> <span class="keyword">extends</span> <span class="title">BaseAction</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//注入 crm 代理对象</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ICustomerService proxy;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="关联客户绑定事件函数"><a href="#关联客户绑定事件函数" class="headerlink" title="关联客户绑定事件函数"></a>关联客户绑定事件函数</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doAssociations</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">//获取当前选中所有行，返回数组</span></span><br><span class="line">  <span class="keyword">var</span> rows = $(<span class="string">"#grid"</span>).datagrid(<span class="string">'getSelections'</span>);</span><br><span class="line">  <span class="keyword">if</span>(rows.length != <span class="number">1</span>)&#123;</span><br><span class="line">      <span class="comment">//选中多个或没有选择定区</span></span><br><span class="line">      $.messager.alert(<span class="string">"提示信息"</span>,<span class="string">"请选择一个定区进行操作"</span>,<span class="string">"message"</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">//选中一个定区</span></span><br><span class="line">         $(<span class="string">'#customerWindow'</span>).window(<span class="string">'open'</span>);</span><br><span class="line">         <span class="comment">//清理下拉框</span></span><br><span class="line">         $(<span class="string">"#noassociationSelect"</span>).empty();</span><br><span class="line">         <span class="comment">//发送 ajax 请求，在定区 action 中通过 crm 代理对象完成 crm 远程调用获取客户数据</span></span><br><span class="line">    <span class="keyword">var</span> url_1 = <span class="string">"DecidedzoneAction_findListNotAssociation.action"</span>;</span><br><span class="line">    $.post(url_1,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">             <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;data.length;i++)&#123;</span><br><span class="line">                 <span class="keyword">var</span> id = data[i].id;</span><br><span class="line">                 <span class="keyword">var</span> name=data[i].name;</span><br><span class="line">                 <span class="keyword">var</span> telephone = data[i].telephone;</span><br><span class="line">                 name = name + <span class="string">"("</span> + telephone + <span class="string">")"</span>;</span><br><span class="line">        $(<span class="string">"#noassociationSelect"</span>).append(<span class="string">"&lt;option id='"</span>+id+<span class="string">"'&gt;"</span>+name+<span class="string">"&lt;/option&gt;"</span>);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">         <span class="comment">//清理下拉框</span></span><br><span class="line">         $(<span class="string">"#associationSelect"</span>).empty();</span><br><span class="line">         <span class="keyword">var</span> decidedzoneId = rows[<span class="number">0</span>].id;</span><br><span class="line">         <span class="comment">//发送 ajax 请求，在定区 action 中通过 crm 代理对象完成 crm 远程调用获取客户数据</span></span><br><span class="line">         <span class="keyword">var</span> url_2 = <span class="string">"DecidedzoneAction_findListHasAssociation.action?"</span>;</span><br><span class="line">         $.post(url_2,&#123;<span class="string">"id"</span>:decidedzoneId&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">             <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;data.length;i++)&#123;</span><br><span class="line">                 <span class="keyword">var</span> id = data[i].id;</span><br><span class="line">                 <span class="keyword">var</span> name=data[i].name;</span><br><span class="line">                 <span class="keyword">var</span> telephone = data[i].telephone;</span><br><span class="line">                 name = name + <span class="string">"("</span> + telephone + <span class="string">")"</span>;</span><br><span class="line">                 $(<span class="string">"#associationSelect"</span>).append(<span class="string">"&lt;option id='"</span>+id+<span class="string">"'&gt;"</span>+name+<span class="string">"&lt;/option&gt;"</span>);</span><br><span class="line"></span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>页面根据 ajax 请求访问后台，传回 json 数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注入 crm 代理对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ICustomerService proxy;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询未关联定区的客户</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">findListNotAssociation</span><span class="params">()</span></span>&#123;</span><br><span class="line">    List&lt;Customer&gt; list = proxy.findListNotAssociation();</span><br><span class="line">    java2Json(list,<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span> NONE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询已关联定区的客户</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">findListHasAssociation</span><span class="params">()</span></span>&#123;</span><br><span class="line">    List&lt;Customer&gt; list = proxy.findListHasAssociation(model.getId());</span><br><span class="line">    java2Json(list,<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NONE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>$(“#id”).append(“value”) 相当于一个剪切效果，将 value 原本的值剪切到 id 的位置</p>
<blockquote>
<p>1、空格表示获取所有子孙后代元素<br>2、 &gt;表示获取一级子元素<br>3、next函数获取紧接在之后的同辈元素列表<br>4、nextAll函数表示获取之后的所有同辈元素列表<br>5、siblings函数表示获取所有同辈元素列表，无论前后</p>
<p><a href="https://blog.csdn.net/luanpeng825485697/article/details/77640154" target="_blank" rel="noopener">jquery 层次选择器</a></p>
</blockquote>
<p>为转移用户和提交客户按钮绑定事件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line"> <span class="comment">// 添加将左边窗口名字转移到右边的方法</span></span><br><span class="line"> $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $(<span class="string">"#toRight"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">       $(<span class="string">"#associationSelect"</span>).append($(<span class="string">"#noassociationSelect option:selected"</span>));</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br><span class="line"> $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $(<span class="string">"#toLeft"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">       $(<span class="string">"#noassociationSelect"</span>).append($(<span class="string">"#associationSelect option:selected"</span>));</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;);</span><br><span class="line"> <span class="comment">// 添加提交表单功能</span></span><br><span class="line">         $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">             $(<span class="string">"#associationBtn"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                 <span class="keyword">var</span> rows = $(<span class="string">"#grid"</span>).datagrid(<span class="string">"getSelections"</span>)[<span class="number">0</span>];</span><br><span class="line">                 <span class="keyword">var</span> id = rows.id;</span><br><span class="line">                 $(<span class="string">"input[name=id]"</span>).val(id);</span><br><span class="line">                 <span class="comment">//提交前将选项全部选中，option 添加 selected</span></span><br><span class="line">     $(<span class="string">"#customerForm option"</span>).attr(<span class="string">"selected"</span>,<span class="string">"selected"</span>);</span><br><span class="line">     alert(<span class="string">"选择"</span>);</span><br><span class="line">                 $(<span class="string">"#customerForm"</span>).submit();</span><br><span class="line">             &#125;);</span><br><span class="line">         &#125;);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="给-crm-服务端扩展定区关联客户方法"><a href="#给-crm-服务端扩展定区关联客户方法" class="headerlink" title="给 crm 服务端扩展定区关联客户方法"></a>给 crm 服务端扩展定区关联客户方法</h5><p>action</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 远程调用 crm 将客户关联到定区</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">assigncustomerstodecidedzone</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        proxy.assigncustomerstodecidedzone(model.getId(),customerIds);</span><br><span class="line">        <span class="keyword">return</span> LIST;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//    属性驱动获得页面提交的多个客户 id</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; customerIds;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCustomerIds</span><span class="params">(List&lt;Integer&gt; customerIds)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.customerIds = customerIds;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Webservice</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定区关联客户</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> decidedzonedId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> customerIds</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">assigncustomerstodecidedzone</span><span class="params">(String decidedzonedId, Integer[] customerIds)</span> </span>&#123;</span><br><span class="line">    String sql = <span class="string">"update t_customer set decidedzone_id = null where decidedzone_id = ?;"</span>;</span><br><span class="line">    jdbcTemplate.update(sql,decidedzonedId);</span><br><span class="line"></span><br><span class="line">    sql = <span class="string">"update t_customer set decidedzone_id = ? where id = ?"</span>;</span><br><span class="line">    <span class="keyword">for</span>(Integer id :customerIds)&#123;</span><br><span class="line">        jdbcTemplate.update(sql,decidedzonedId,id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="查看分区中关联的方法"><a href="#查看分区中关联的方法" class="headerlink" title="查看分区中关联的方法"></a>查看分区中关联的方法</h5><p>绑定 双击方法，创建双击方法函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doDblClickRow</span>(<span class="params">rowIndex,rowData</span>)</span>&#123;</span><br><span class="line">     <span class="comment">// rowIndex: 点击的行索引,从0</span></span><br><span class="line">     <span class="comment">// rowData: 点击对应的记录行</span></span><br><span class="line"> alert(<span class="string">"双击表格数据..."</span>);</span><br><span class="line"> $(<span class="string">'#association_subarea'</span>).datagrid( &#123;</span><br><span class="line">  fit : <span class="literal">true</span>,</span><br><span class="line">  border : <span class="literal">true</span>,</span><br><span class="line">  rownumbers : <span class="literal">true</span>,</span><br><span class="line">  striped : <span class="literal">true</span>,</span><br><span class="line">  url : <span class="string">"SubareaAction_findListByDecidedzoneId.action?id="</span>+rowData.id,</span><br><span class="line">  columns : [ [&#123;</span><br><span class="line">   field : <span class="string">'id'</span>,</span><br><span class="line">   title : <span class="string">'分拣编号'</span>,</span><br></pre></td></tr></table></figure>
<p>action 根据定区 id 查看关联分区</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据定区 id 查看关联分区</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">findListByDecidedzoneId</span><span class="params">()</span></span>&#123;</span><br><span class="line">    List&lt;Subarea&gt; list =  subareaService.findListByDecidedzoneId(decidedzoneId);</span><br><span class="line">    <span class="keyword">this</span>.java2Json(list,<span class="keyword">new</span> String[]&#123;<span class="string">"decidedzone"</span>,<span class="string">"subareas"</span>&#125;);</span><br><span class="line">    <span class="keyword">return</span> NONE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> String decidedzoneId;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDecidedzoneId</span><span class="params">(String decidedzoneId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.decidedzoneId = decidedzoneId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据定区 id 查询关联的 分区</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> decidedzoneId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Subarea&gt; <span class="title">findListByDecidedzoneId</span><span class="params">(String decidedzoneId)</span> </span>&#123;</span><br><span class="line">    DetachedCriteria detachedCriteria = DetachedCriteria.forClass(Subarea.class);</span><br><span class="line">    <span class="comment">//添加过滤条件，单表查询不需要别名</span></span><br><span class="line">    detachedCriteria.add(Restrictions.eq(<span class="string">"decidedzone.id"</span>,decidedzoneId));</span><br><span class="line">    <span class="keyword">return</span> subareaDao.findByCriteria(detachedCriteria);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>yum ：Yellow dog Updater Modified,（黄狗升级修改器）软件包管理器，能从指定服务器自动下载 RPM 包并安装，可以自动处理依赖关系，并一次安装所有依赖软件包，无需多次下载安装</p>
<hr>
<h5 id="业务受理需求"><a href="#业务受理需求" class="headerlink" title="业务受理需求"></a>业务受理需求</h5><p>逆向工程生成 bean.hbm.xml</p>
<p><img src="D:\hexo\source\_posts\BOS-later\%5CUsers%5CZHIEND%5CDesktop%5C%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B.png" alt="idea 生成 hbm"></p>
<p>在 crm 拓展方法：</p>
<ul>
<li>根据客户手机号查询客户的信息</li>
<li>根据客户的取件地址查询定区的 id（定区 id 可以查询是哪个取派员负责的地区）</li>
</ul>
<p>在 bos 添加 页面绑定事件 与 action</p>
<ul>
<li>为手机号输入框绑定事件，根据手机号回显用户 id name 与 联系人信息</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;td&gt;来电号码:<span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line">&lt;td&gt;<span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"easyui-validatebox"</span> <span class="attr">name</span>=<span class="string">"telephone"</span></span></span></span><br><span class="line"><span class="xml"> required="true" /&gt;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line"> $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//页面加载完成后为手机号输入框绑定离焦事件</span></span><br><span class="line">   $(<span class="string">"input[name='telephone']"</span>).blur(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">       <span class="comment">//获取页面输入的手机号</span></span><br><span class="line">     <span class="keyword">var</span> telephone = <span class="keyword">this</span>.value;</span><br><span class="line">     <span class="comment">//发送 ajax 请求，服务器调用 crm 服务器，获取客户信息用于页面显示</span></span><br><span class="line">     $.post(<span class="string">'NoticebillAction_findCustomerByTelephone.action'</span>,</span><br><span class="line">       &#123;<span class="string">"telephone"</span>:telephone&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">         <span class="keyword">if</span>(data!=<span class="literal">null</span>)&#123;</span><br><span class="line">             $(<span class="string">"input[name='customerName']"</span>).val(data.name);</span><br><span class="line">             $(<span class="string">"input[name='customerId']"</span>).val(data.id);</span><br><span class="line">             $(<span class="string">"input[name='delegater']"</span>).val(data.name);</span><br><span class="line">             $(<span class="string">"input[name='pickaddress']"</span>).val(data.address);</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                       $(<span class="string">"input[name='customerName']"</span>).val(<span class="string">""</span>);</span><br><span class="line">                       $(<span class="string">"input[name='customerId']"</span>).val(<span class="string">""</span>);</span><br><span class="line">                       $(<span class="string">"input[name='delegater']"</span>).val(<span class="string">""</span>);</span><br><span class="line">                       $(<span class="string">"input[name='pickaddress']"</span>).val(<span class="string">""</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">     &#125;);</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>创建 NoticebillAction，注入 crm 代理方法，提供根据手机号查找用户信息的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//导入 crm customerService 服务</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ICustomerService customerService;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据电话号码查找用户</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">findCustomerByTelephone</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Customer customerByTelephone = customerService.findCustomerByTelephone(model.getTelephone());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.java2Json(customerByTelephone,<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span> NONE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="业务受理自动分单"><a href="#业务受理自动分单" class="headerlink" title="业务受理自动分单"></a>业务受理自动分单</h5><p>action </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//    导入 NoticebillService 服务</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> INoticebillService noticebillService;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存一个业务通知单，尝试自动分单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">        noticebillService.save(model);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"noticebill_add"</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoticebillServiceImpl</span> <span class="keyword">implements</span> <span class="title">INoticebillService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> INoticebillDao noticebillDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IDecidedzoneDao decidedzoneDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IWorkbillDao workbillDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ICustomerService customerService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存业务通知单，尝试自动分单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(Noticebill model)</span> </span>&#123;</span><br><span class="line">        User loginUser = BOSUtils.getLoginUser();</span><br><span class="line">        model.setUser(loginUser);<span class="comment">//设置当前登录用户</span></span><br><span class="line">        noticebillDao.save(model);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取客户取货地址</span></span><br><span class="line">        String address = model.getPickaddress();</span><br><span class="line">        <span class="comment">//远程调用客户方法根据地址获得定区id</span></span><br><span class="line">        String decidedzoneId = customerService.findDecidedzoneIdByAddress(address);</span><br><span class="line">        <span class="keyword">if</span>(decidedzoneId!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">//查询到定区id可以自动分单</span></span><br><span class="line">            Decidedzone decidedzone = decidedzoneDao.findById(decidedzoneId);</span><br><span class="line">            Staff staff = decidedzone.getStaff();</span><br><span class="line">            model.setStaff(staff);<span class="comment">//业务通知单关联取派员对象</span></span><br><span class="line">            <span class="comment">//设置自动分单</span></span><br><span class="line">            model.setOrdertype(Noticebill.ORDERTYPE_AUTO);</span><br><span class="line">            <span class="comment">//为取派员生成一个工单</span></span><br><span class="line">            Workbill workbill = <span class="keyword">new</span> Workbill();</span><br><span class="line">            workbill.setAttachbilltimes(<span class="number">0</span>);<span class="comment">//追单次数</span></span><br><span class="line">            workbill.setBuildtime(<span class="keyword">new</span> Timestamp(System.currentTimeMillis()));<span class="comment">//精确到秒的时间值</span></span><br><span class="line">            workbill.setNoticebill(model);<span class="comment">//工单关联业务通知单</span></span><br><span class="line">            workbill.setPickstate(Workbill.PICKSTATE_NO);<span class="comment">//取件状态</span></span><br><span class="line">            workbill.setRemark(model.getRemark());<span class="comment">//添加备注</span></span><br><span class="line">            workbill.setStaff(staff);<span class="comment">//关联取派员</span></span><br><span class="line">            workbill.setType(Workbill.ORDERTYPE_1);<span class="comment">//工单类型</span></span><br><span class="line">            workbillDao.save(workbill);</span><br><span class="line">            <span class="comment">//调用短信平台发短信</span></span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//查不到不能自动分单</span></span><br><span class="line">            model.setOrdertype(Noticebill.ORDERTYPE_MAN);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>datagrid 数据表格编辑功能使用方式</p>
<p>数据表格编辑功能以列为单位</p>
<p>以列属性来指定哪列具有编辑功能</p>
<hr>
<h5 id="权限控制"><a href="#权限控制" class="headerlink" title="权限控制"></a>权限控制</h5><ul>
<li><p>拦截权限控制</p>
<p>底层根据 过滤器 或 拦截器 实现</p>
</li>
<li><p>方法注解权限控制</p>
<p>底层基于代理技术实现，为 Action 设置一个注解，那么就会给 Action 创建代理对象，由代理对象进行权限校验（类似事务控制的 transactional） </p>
</li>
</ul>
<p>authenticate:权限，认证</p>
<p>anonymous:匿名</p>
<p>认证：系统提供的用于识别用户身份的功能，通常认证就是登陆–让系统知道你是谁</p>
<p>授权：系统授予用户可以访问那些功能的许可（证书）–让系统知道你能干什么</p>
<p>创建权限控制模型：</p>
<ul>
<li>权限表</li>
<li>角色表</li>
<li>用户表</li>
<li>角色权限关系表</li>
<li>用户权限关系表</li>
<li>资源表（用来对应是否有某个按钮功能）</li>
<li>资源权限关系表</li>
</ul>
<p>资源表与资源权限表不一定存在</p>
<p>早期框架 EJB 框架（enterprise java bean， 企业级 java bean，已被 spring 替代）</p>
<ul>
<li>entity bean （实体bean）– hibernate</li>
<li>session bean （会话 bean）</li>
<li>message bean（信息 bean）</li>
</ul>
<hr>
<h4 id="shiro-框架"><a href="#shiro-框架" class="headerlink" title="shiro 框架"></a>shiro 框架</h4><p>认证流程：</p>
<p>Application Code：应用程序代码，由开发人员负责开发</p>
<p>subject：提供框架的接口，代表当前用户对象</p>
<p>SecurityManager：框架提供的接口，代表安全管理器对象</p>
<p>Realm：可以开发人员编写，框架也提供一部分，类似于 DAO ，用于访问权限数据</p>
<p>Application Code–&gt;subject–&gt;shiro SecurityManager–&gt;Realm</p>
<p>shiro 的使用</p>
<ul>
<li><p>在项目的 pom.xml 中引入 shiro 的依赖（shiro-all）</p>
</li>
<li><p>在 web.xml 中配置一个过滤器，spring 提供的，用于整合 shiro 框架</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置spring框架提供的用于整合shiro框架的过滤器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 spring 中配置文件中配置 bean ，id 为 shiroFilter</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置 shiro 框架的过滤器工厂对象--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"shiroFilter"</span> <span class="attr">class</span>=<span class="string">"org.apache.shiro.spring.web.ShiroFilterFactoryBean"</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--注入安全器管理对象--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"securityManager"</span> <span class="attr">ref</span>=<span class="string">"securityManager"</span>/&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--注入相关页面访问 URL--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"loginUrl"</span> <span class="attr">value</span>=<span class="string">"/login.jsp"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"successUrl"</span> <span class="attr">value</span>=<span class="string">"/index.jsp"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"unauthorizedUrl"</span> <span class="attr">value</span>=<span class="string">"/unauthorized.jsp"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">&lt;!--注入 url 拦截器规则--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"filterChainDefinitions"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">         /css/** = anon</span><br><span class="line">         /js/** = anon</span><br><span class="line">         /images/** = anon</span><br><span class="line">         /validatecode.jsp* = anon</span><br><span class="line">         /*login.jsp = anon</span><br><span class="line">         /UserAction_login.action = anon</span><br><span class="line">         /page_base_staff.action = perms["staff-list"]</span><br><span class="line">         /* = authc</span><br><span class="line">      <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>anon：匿名访问过滤器，没登录时也能访问</p>
<p>authc：登录访问，不登录不能访问</p>
<p>perms：指定权限校验</p>
<p>roles：指定某个角色</p>
<p>ssl：指定是否安全链接，https </p>
</li>
<li><p>在 spring 中配置安全管理器</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--注册安全管理器对象--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"securityManager"</span> <span class="attr">class</span>=<span class="string">"org.apache.shiro.web.mgt.DefaultWebSecurityManager"</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--根据 DefaultWebSecurityManager 父类的 setRealm 方法注入--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"realm"</span> <span class="attr">ref</span>=<span class="string">"bosRealm"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 UserAction 的 login 方法，使用 shiro 提供的方式进行认证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户登录方法,使用 shiro 框架</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//        查看验证码是否正确，先从 session 获得正确的验证码</span></span><br><span class="line">        String validatecode = (String) ServletActionContext.getRequest().getSession().getAttribute(<span class="string">"key"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isNotBlank(checkcode) &amp;&amp; checkcode.equals(validatecode))&#123;</span><br><span class="line"><span class="comment">//            使用 shiro 框架提供的方式进行认证</span></span><br><span class="line">            Subject subject = SecurityUtils.getSubject();<span class="comment">//获得当前用户对象，状态为未认证</span></span><br><span class="line">            AuthenticationToken token = <span class="keyword">new</span> UsernamePasswordToken(model.getUsername(), MD5Utils.md5(model.getPassword()));</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                subject.login(token);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">return</span> LOGIN;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//取出放到 SimpleAuthenticationInfo 的第一个参数</span></span><br><span class="line">            User user = (User) subject.getPrincipal();</span><br><span class="line">            ServletActionContext.getRequest().getSession().setAttribute(<span class="string">"loginUser"</span>,user);</span><br><span class="line">            <span class="keyword">return</span> HOME;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//验证码错误</span></span><br><span class="line">            <span class="keyword">this</span>.addActionError(<span class="string">"验证码错误"</span>);</span><br><span class="line">            <span class="keyword">return</span> LOGIN;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自定义 realm，并注入给安全管理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="comment">//认证方法</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"自定义 realm 认证方法"</span>);</span><br><span class="line">    <span class="comment">//根据用户名查询数据库中的方法</span></span><br><span class="line">    UsernamePasswordToken passwordToken = (UsernamePasswordToken) token;</span><br><span class="line">    <span class="comment">//获得页面输入的用户名</span></span><br><span class="line">    String username = passwordToken.getUsername();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据用户名查询数据库中的密码</span></span><br><span class="line">    User user = userDao.findUserByUserName(username);</span><br><span class="line">    <span class="keyword">if</span>(user==<span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="comment">//页面输入用户名不存在</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//框架对比数据库中密码与页面密码是否一致,第一个参数将 user 放到了本地线程，可以通过 subject.getPrinclpal() 取出</span></span><br><span class="line">    AuthenticationInfo info = <span class="keyword">new</span> SimpleAuthenticationInfo(user,user.getPassword(),<span class="keyword">this</span>.getName());</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--注册 realm--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"bosRealm"</span> <span class="attr">class</span>=<span class="string">"com.itheima.bos.realm.BOSRealm"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="使用-shiro-的方法注解方式权限控制"><a href="#使用-shiro-的方法注解方式权限控制" class="headerlink" title="使用 shiro 的方法注解方式权限控制"></a>使用 shiro 的方法注解方式权限控制</h5><ul>
<li><p>在 spring 配置文件中开启 shiro 注解支持</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">默认	  切面（切点+通知） 自动 代理 创建器</span><br><span class="line">DefaultAdvisorAutoProxyCreator</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--开启 shiro 的注释--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--自动代理--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"defaultAdvisorAutoProxyCreator"</span> <span class="attr">class</span>=<span class="string">"org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--ture 强制使用 cglib 创建 Action 代理 如果 value 为 true 对目标类进行强制代理，</span></span><br><span class="line"><span class="comment">		cglib 会继承 Action 方法，因为 Action 的子类必定有需要的方法，所以不会报错；</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">		false 则使用 jdk 代理，会实现一个接口（Service 没接口则实现其父类</span></span><br><span class="line"><span class="comment">		ModelDriven 的接口），创建接口的代理类对象，调用其方法如果该接口中没有需要的方法，则会抛出 noSuchMethodExction 异常--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"proxyTargetClass"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--切面类--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 Action 方法上使用注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取派员批量删除方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequiresPermissions</span>(<span class="string">"staff-delete"</span>)<span class="comment">//执行该方法需要当前用户具有 staff-delete 权限</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">deleteBatch</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//        service 上加了事务注解，那么 staffService 就是一个 代理对象（proxy），走完这个方法才会提交事务</span></span><br><span class="line">        staffService.deleteBatch(ids);</span><br><span class="line">        <span class="keyword">return</span> LIST;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 struts.xml 中配置全局异常捕获，当 shiro 框架抛出权限不足异常时，跳转到权限不足页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">异常：</span><br><span class="line">21:06:44,124 DEBUG DefaultActionInvocation:76 - Executing action method = deleteBatch</span><br><span class="line">21:06:44,128 DEBUG AuthorizingRealm:234 - No authorizationCache instance set.  Checking for a cacheManager...</span><br><span class="line">21:06:44,129  INFO AuthorizingRealm:248 - No cache or cacheManager properties have been set.  Authorization cache cannot be obtained.</span><br><span class="line">21:06:44,133 DEBUG XWorkMethodAccessor:84 - Error calling method through OGNL: object: [com.itheima.bos.web.action.StaffAction@116394d] method: [deleteBatch] args: [[]]</span><br><span class="line">org.apache.shiro.authz.UnauthorizedException: Subject does not have permission [staff-delete]at org.apache.shiro.authz.ModularRealmAuthorizer.checkPermission(ModularRealmAuthorizer.java:323)</span><br><span class="line">	at org.apache.shiro.mgt.AuthorizingSecurityManager.checkPermission(AuthorizingSecurityManager.java:137)</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--全局 result 结果集 定义--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">global-results</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">"login"</span>&gt;</span>/login.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">"unauthorized"</span>&gt;</span>/unauthorized.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">global-results</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">global-exception-mappings</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置全局异常，将 shiro 无权限的异常捕获，跳转到权限不足页面，将其配置到全局结果集--&gt;</span></span><br><span class="line">   			<span class="tag">&lt;<span class="name">exception-mapping</span> <span class="attr">exception</span>=<span class="string">"org.apache.shiro.authz.UnauthorizedException"</span> <span class="attr">result</span>=<span class="string">"unauthorized"</span>&gt;</span><span class="tag">&lt;/<span class="name">exception-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">global-exception-mappings</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="使用-shiro-的页面标签方式控制权限"><a href="#使用-shiro-的页面标签方式控制权限" class="headerlink" title="使用 shiro 的页面标签方式控制权限"></a>使用 shiro 的页面标签方式控制权限</h5><ul>
<li><p>在 jsp 页面引入 shiro 的标签库</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%@taglib</span> <span class="attr">prefix</span>=<span class="string">"shiro"</span> <span class="attr">uri</span>=<span class="string">"http://shiro.apache.org/tags"</span> %&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 shiro 标签控制页面元素展示</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;shiro:hasPermission name=<span class="string">"staff-list"</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    id: <span class="string">'button-delete'</span>,</span><br><span class="line">    text: <span class="string">'作废'</span>,</span><br><span class="line">    iconCls: <span class="string">'icon-cancel'</span>,</span><br><span class="line">    handler: doDelete</span><br><span class="line">&#125;,</span><br><span class="line">&lt;/shiro:hasPermission&gt;</span><br></pre></td></tr></table></figure>
<p>标签的底层是 java 类，运行时运行的是 java 代码</p>
</li>
<li><p>代码级别权限控制（了解）</p>
<p>在方法的第一行加权限控制代码</p>
<p>能在刚运行方法时进行校验，如果没有权限则抛出异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Subject subject = SecurityUtils.getSubject();</span><br><span class="line">subject.checkPermission(<span class="string">"staff-delete"</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="权限数据管理"><a href="#权限数据管理" class="headerlink" title="权限数据管理"></a>权限数据管理</h5><ul>
<li><p>初始化权限数据</p>
<p>项目上线后，正常运行需要依赖一些基础数据支持，权限数据就属于基础数据，系统菜单就是从权限表查询获得的。一般提供 sql 脚本文件，导入基础数据</p>
</li>
<li><p>添加权限数据</p>
<ol>
<li><p>修改父功能点对应的  combobox ，修改 URL 地址</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;td&gt;父功能点&lt;/td&gt;</span><br><span class="line">&lt;td&gt;</span><br><span class="line"> &lt;input name=<span class="string">"parentFunction.id"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"easyui-combobox"</span> data-options=<span class="string">"valueField:'id',textField:'info',</span></span><br><span class="line"><span class="string"> url:'functionAction_listajax.action'"</span>/&gt;</span><br><span class="line">&lt;/td&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 FunctionAction、Service、Dao，查询所有权限，返回 json</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Scope</span>(<span class="string">"prototype"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FunctionAction</span> <span class="keyword">extends</span> <span class="title">BaseAction</span>&lt;<span class="title">Function</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IFunctionService functionService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有权限返回 json 数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">listajax</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;Function&gt; list = functionService.findAll();</span><br><span class="line">        <span class="keyword">this</span>.java2Json(list,<span class="keyword">new</span> String[]&#123;<span class="string">"parentFunction"</span>,<span class="string">"children"</span>,<span class="string">"roles"</span>&#125;);</span><br><span class="line">        <span class="keyword">return</span> NONE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 strut.xml</p>
</li>
<li><p>为页面添加保存按钮事件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 查询所有权限返回 json 数据</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">public String listajax()&#123;</span><br><span class="line">    List&lt;Function&gt; list = functionService.findAll();</span><br><span class="line">    this.java2Json(list,new String[]&#123;&quot;parentFunction&quot;,&quot;children&quot;,&quot;roles&quot;&#125;);</span><br><span class="line">    return NONE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>权限分页查询</p>
<ol>
<li><p>给 datagrid 的 url 添加地址</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"> $(<span class="string">"#grid"</span>).datagrid(&#123;</span><br><span class="line">  toolbar : [</span><br><span class="line">   &#123;</span><br><span class="line">    id : <span class="string">'add'</span>,</span><br><span class="line">    text : <span class="string">'添加权限'</span>,</span><br><span class="line">    iconCls : <span class="string">'icon-add'</span>,</span><br><span class="line">    handler : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     location.href=<span class="string">'$&#123;pageContext.request.contextPath&#125;/page_admin_function_add.action'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;           </span><br><span class="line">  ],</span><br><span class="line">  url : <span class="string">'FunctionAction_pageQuery.action'</span>,</span><br><span class="line">   pagination:<span class="literal">true</span>,</span><br><span class="line">   fit:<span class="literal">true</span>,</span><br><span class="line">  columns : [[</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 Action 中提供查询方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 分页查询方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">pageQuery</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//重新手动设置属性驱动与模型驱动冲突的属性</span></span><br><span class="line">    pageBean.setCurrentPage(Integer.parseInt(model.getPage()));</span><br><span class="line">    functionService.pageQuery(pageBean);</span><br><span class="line">    <span class="keyword">this</span>.java2Json(pageBean,<span class="keyword">new</span> String[]&#123;<span class="string">"roles"</span>,<span class="string">"children"</span>,<span class="string">"parentFunction"</span>&#125;);</span><br><span class="line">    <span class="keyword">return</span> NONE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ul>
<p>struts 属性重复错误</p>
<p>struts 属性驱动与模型驱动的属性重复时，优先给模型驱动赋值，若要正确传入重复的属性可以自己进行设置（从模型驱动取出同名值赋给属性驱动的那个属性）</p>
<hr>
<h5 id="使下拉框变为层级格式"><a href="#使下拉框变为层级格式" class="headerlink" title="使下拉框变为层级格式"></a>使下拉框变为层级格式</h5><ul>
<li>页面上使用 combotree </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;td&gt;父功能点&lt;/td&gt;</span><br><span class="line">&lt;td&gt;</span><br><span class="line"> &lt;input name=<span class="string">"parentFunction.id"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"easyui-combotree"</span></span><br><span class="line">     data-options=<span class="string">"url:'FunctionAction_listajax.action'"</span>/&gt;</span><br><span class="line">&lt;/td&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>重写列表查询方法，使其有查询无父节点的节点功能</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Function&gt; <span class="title">findAll</span><span class="params">()</span></span>&#123;</span><br><span class="line">    String hql = <span class="string">"FROM Function f WHERE f.parentFunction IS NULL"</span>;</span><br><span class="line">    List&lt;Function&gt; functionList = (List&lt;Function&gt;)<span class="keyword">this</span>.getHibernateTemplate().find(hql);</span><br><span class="line">    <span class="keyword">return</span> functionList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 Function.hbm.xml 中将 children 改为立即加载，使其加载无父节点的顶级节点同时加载子类节点</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">set</span> <span class="attr">name</span>=<span class="string">"children"</span> <span class="attr">inverse</span>=<span class="string">"true"</span> <span class="attr">lazy</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">"pid"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">one-to-many</span> <span class="attr">not-found</span>=<span class="string">"ignore"</span> <span class="attr">class</span>=<span class="string">"com.itheima.bos.domain.Function"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在 Function.java 的 bean 中添加 getText() 方法，因为 combotree 需要 id 与 text 字段来显示，getText() 方法可以使其在转换为 json 格式时添加一个 text 字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在转换 json 时加入一个 text 字段</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getText</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="添加角色功能"><a href="#添加角色功能" class="headerlink" title="添加角色功能"></a>添加角色功能</h5><ul>
<li><p>修改页面，使用 ztree 勾选效果</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"> <span class="comment">// 授权树初始化</span></span><br><span class="line"> <span class="keyword">var</span> setting = &#123;</span><br><span class="line">  data : &#123;</span><br><span class="line">   key : &#123;</span><br><span class="line">    title : <span class="string">"t"</span></span><br><span class="line">   &#125;,</span><br><span class="line">   simpleData : &#123;</span><br><span class="line">    enable : <span class="literal">true</span></span><br><span class="line">   &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">     <span class="comment">//此处开启勾选效果</span></span><br><span class="line">  check : &#123;</span><br><span class="line">   enable : <span class="literal">true</span>,</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 ajax 方法的请求 URL 路径</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line"> url : <span class="string">'$&#123;pageContext.request.contextPath&#125;/FunctionAction_listajax.action'</span>,</span><br><span class="line"> type : <span class="string">'POST'</span>,</span><br><span class="line"> dataType : <span class="string">'json'</span>,</span><br><span class="line"> success : <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">     <span class="comment">// 将 dataType 看做 text 格式，并拼接 json 字符串，因为返回的就是 josn 格式字符串，所以不需要</span></span><br><span class="line">  <span class="comment">// var zNodes = eval("(" + data + ")");</span></span><br><span class="line">  $.fn.zTree.init($(<span class="string">"#functionTree"</span>), setting, data);</span><br><span class="line"> &#125;,</span><br><span class="line"> error : <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">  alert(<span class="string">'树加载异常!'</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>为保存按钮绑定事件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 点击保存</span></span><br><span class="line">$(<span class="string">'#save'</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> v = $(<span class="string">"#roleForm"</span>).form(<span class="string">"validate"</span>);</span><br><span class="line">  <span class="keyword">if</span>(v)&#123;</span><br><span class="line">      <span class="comment">//根据 ztree 的 id 获得 ztree 对象</span></span><br><span class="line">    <span class="keyword">var</span> ztreeObj = $.fn.zTree.getZTreeObj(<span class="string">"functionTree"</span>);</span><br><span class="line">    <span class="comment">//获取 ztree 上选中的节点，返回数组对象</span></span><br><span class="line">    <span class="keyword">var</span> checkedNodes = ztreeObj.getCheckedNodes(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> array = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">    <span class="comment">//遍历数组，获得权限 id,将其加入集合</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;checkedNodes.length;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> id = checkedNodes[i].id;</span><br><span class="line">        array.push(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将 ids 添加到隐藏域的 name 属性上，使表单能提交 ids</span></span><br><span class="line">    $(<span class="string">"input[name=functionIds]"</span>).val(array);</span><br><span class="line">      $(<span class="string">"#roleForm"</span>).submit();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务端实现</p>
<p>action</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 角色管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Scope</span>(<span class="string">"prototype"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleAction</span> <span class="keyword">extends</span> <span class="title">BaseAction</span>&lt;<span class="title">Role</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//属性驱动，接受 ids</span></span><br><span class="line">    <span class="keyword">private</span> String functionIds;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//get 方法只有在页面回显，用 ognl 表达式 或 struts 标签显示时 struts 才会调用 get 方法</span></span><br><span class="line"><span class="comment">//    public String getFunctionIds() &#123;</span></span><br><span class="line"><span class="comment">//        return functionIds;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//set 方法用于接受页面传过来的属性</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFunctionIds</span><span class="params">(String functionIds)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.functionIds = functionIds;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IRoleService roleService;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加角色</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">        roleService.save(model,functionIds);</span><br><span class="line">        <span class="keyword">return</span> LIST;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>service  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleServiceImpl</span> <span class="keyword">implements</span> <span class="title">IRoleService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IRoleDao roleDao;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存一个角色，同时关联一个对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(Role model, String functionIds)</span> </span>&#123;</span><br><span class="line">        roleDao.save(model);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isNotBlank(functionIds))&#123;</span><br><span class="line">            String[] fIds = functionIds.split(<span class="string">","</span>);</span><br><span class="line">            <span class="keyword">for</span>(String functionId : fIds)&#123;</span><br><span class="line">                <span class="comment">//可以根据 Function id 查询 Function 对象，也可以直接创建一个 Function 对象，给他一个 id</span></span><br><span class="line">                <span class="comment">//因为有 id 所以对象为托管状态，而不是游离状态</span></span><br><span class="line">                Function function = <span class="keyword">new</span> Function(functionId);</span><br><span class="line">                <span class="comment">//角色关联，持久状态对象能关联托管状态，不能关联瞬时状态,</span></span><br><span class="line">                <span class="comment">//如果 Role.hbm.xml 中设置了 inverse="true" 则不能让角色关联权限了(放弃维护关系)</span></span><br><span class="line">                model.getFunctions().add(function);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p><a href="https://blog.csdn.net/qq_33248299/article/details/72852588" target="_blank" rel="noopener">Hibernate 实体类三种状态</a></p>
<p>瞬时态:对象里面没有id值,对象与session没有关联</p>
<p>持久态:对象里面有id值,对象与session关联</p>
<p>托管态:对象有id值,对象与session没有关系</p>
<p>实体类只是瞬时态的时候,才做添加操作</p>
<p>实体类是持久态和托管态的时候,都做的是修改操作</p>
</blockquote>
<hr>
<h5 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a>用户管理</h5><ul>
<li><p>添加用户</p>
<p>发送 ajax 请求，获取角色数据，在回调函数中动态显示角色数据，展示为 checkbox</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;tr&gt;</span><br><span class="line"> &lt;td&gt;选择角色:<span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"> &lt;td colspan=<span class="string">"3"</span> id=<span class="string">"roleTD"</span>&gt;</span><br><span class="line">  &lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">   <span class="comment">// 该页面是浏览器根据 js 代码运算获得的，在浏览器查看页面元素-查看框架源代码（查看的是服务器 tomcat 运算后传过来的代码）中只能看到 js 代码，</span></span><br><span class="line">   <span class="comment">// 但在浏览器工具可以查看元素查看运算后代码</span></span><br><span class="line">   $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">       <span class="comment">//页面加载完成后，发送 ajax 请求，获取所有角色数据</span></span><br><span class="line">     $.post(<span class="string">'RoleAction_listajax.action'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">         <span class="comment">//在 ajax 回调函数解析 json 数据，展示为 checkbox</span></span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;data.length;i++)&#123;</span><br><span class="line">           <span class="keyword">var</span> name = data[i].name;</span><br><span class="line">           <span class="keyword">var</span> id = data[i].id;</span><br><span class="line">           $(<span class="string">"#roleTD"</span>).append(<span class="string">'&lt;input type="checkbox" id="'</span>+id+<span class="string">'" name="roleIds" value="'</span>+id+<span class="string">'"/&gt;&lt;label for="'</span>+id+<span class="string">'"&gt;'</span>+name+<span class="string">'&lt;/label&gt;'</span>);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;);</span><br><span class="line">             &#125;);</span><br><span class="line">  &lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">  &lt;%--添加选择框点击文字可勾选属性--%&gt;</span></span><br><span class="line"><span class="regexp">  &lt;%--&lt;input type="checkbox" value="abc" id="test"/</span>&gt;--%&gt;</span><br><span class="line">  &lt;%--<span class="xml"><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"test"</span>&gt;</span>lalala<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span>--%&gt;</span><br><span class="line"> &lt;<span class="regexp">/td&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>tr&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 RoleAction 提供 listajax 方法，提供 json 数据</p>
<p>action</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//属性驱动接受多个角色 id</span></span><br><span class="line"><span class="keyword">private</span> String[] roleIds;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRoleIds</span><span class="params">(String[] roleIds)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.roleIds = roleIds;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存用户方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">    userService.save(model,roleIds);</span><br><span class="line">    <span class="keyword">return</span> LIST;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加一个用户，同时关联角色</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> model</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> roleIds</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(User model, String[] roleIds)</span> </span>&#123;</span><br><span class="line">    String password = model.getPassword();</span><br><span class="line">    password = MD5Utils.md5(password);</span><br><span class="line">    model.setPassword(password);</span><br><span class="line">    userDao.save(model);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(roleIds!=<span class="keyword">null</span>&amp;&amp;roleIds.length&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(String roleId : roleIds)&#123;</span><br><span class="line">            Role role = <span class="keyword">new</span> Role(roleId);</span><br><span class="line">            <span class="comment">//用户对象关联角色对象</span></span><br><span class="line">            model.getRoles().add(role);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>为保存按钮绑定事件，校验并提交表单</li>
</ul>
<hr>
<p>用户管理</p>
<ul>
<li><p>分页查询</p>
<p>action</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户数据的分页查询</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">pageQuery</span><span class="params">()</span></span>&#123;</span><br><span class="line">    userService.pageQuery(pageBean);</span><br><span class="line">    <span class="comment">//json 转换 Date 出现异常，将其排除并使用 getBirthdayString 添加新字段</span></span><br><span class="line">    java2Json(pageBean,<span class="keyword">new</span> String[]&#123;<span class="string">"noticebills"</span>,<span class="string">"roles"</span>,<span class="string">"birthday"</span>&#125;);</span><br><span class="line">    <span class="keyword">return</span> NONE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>user bean </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//拼接 roleName</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getRoleNames</span><span class="params">()</span></span>&#123;</span><br><span class="line">    String roleNames = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span>(Role role : roles)&#123;</span><br><span class="line">        String name = role.getName();</span><br><span class="line">        roleNames += name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> roleNames;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//json 转换 Date 出现异常，将其排除并使用 getBirthdayString 添加新字段</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getBirthdayString</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(birthday!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        String format = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>).format(birthday);</span><br><span class="line">        <span class="keyword">return</span> format;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"暂无数据"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="修改-Realm-中授权方法（查询数据库获得用户权限）"><a href="#修改-Realm-中授权方法（查询数据库获得用户权限）" class="headerlink" title="修改 Realm 中授权方法（查询数据库获得用户权限）"></a>修改 Realm 中授权方法（查询数据库获得用户权限）</h5><ul>
<li><p>BOSRealm</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//授权方法</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">        SimpleAuthorizationInfo info = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">        <span class="comment">//获得当前登录用户 2 种方法，选其一</span></span><br><span class="line">        User user = (User) principals.getPrimaryPrincipal();</span><br><span class="line"><span class="comment">//        User user1 = (User) SecurityUtils.getSubject().getPrincipal();</span></span><br><span class="line">        <span class="comment">//根据当前登录用户查询数据库，获取实际对应的权限</span></span><br><span class="line">        List&lt;Function&gt; list = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(user.getUsername().equals(<span class="string">"admin"</span>))&#123;</span><br><span class="line"><span class="comment">//            如果是内置管理员则查询所有权限</span></span><br><span class="line">            DetachedCriteria detachedCriteria = DetachedCriteria.forClass(Function.class);</span><br><span class="line">            list = functionDao.findByCriteria(detachedCriteria);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            list= functionDao.findFunctionByUserId(user.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(Function f : list)&#123;</span><br><span class="line">            info.addStringPermission(f.getCode());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 FunctionDao 扩展方法，根据用户 id 查询对应权限，用 select 选择需要查询的字段，使用 DISTINCT 去除重复的字段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据用户 id 查询用户对应权限</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Function&gt; <span class="title">findFunctionByUserId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//加上 select f ，让其只查询权限表的字段，就只会封装 Object 对象。如果查询全部表的字段，hibernate 会自动封装成 object 对象</span></span><br><span class="line">    <span class="comment">//DISTINCT 排除查询出来的重复字段</span></span><br><span class="line">    String hql = <span class="string">" SELECT DISTINCT f FROM Function f LEFT OUTER JOIN f.roles r LEFT OUTER JOIN r.users u WHERE u.id=?"</span>;</span><br><span class="line">    List&lt;Function&gt; list = (List&lt;Function&gt;) <span class="keyword">this</span>.getHibernateTemplate().find(hql, id);</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>未添加 Select f 选择查询的语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">        function0_.id <span class="keyword">as</span> id1_0_0_,</span><br><span class="line">        role2_.id <span class="keyword">as</span> id1_1_1_,</span><br><span class="line">        user4_.id <span class="keyword">as</span> id1_10_2_,</span><br><span class="line">        function0_.name <span class="keyword">as</span> name2_0_0_,</span><br><span class="line">        function0_.code <span class="keyword">as</span> code3_0_0_,</span><br><span class="line">        function0_.description <span class="keyword">as</span> descript4_0_0_,</span><br><span class="line">        function0_.page <span class="keyword">as</span> page5_0_0_,</span><br><span class="line">        function0_.generatemenu <span class="keyword">as</span> generate6_0_0_,</span><br><span class="line">        function0_.zindex <span class="keyword">as</span> zindex7_0_0_,</span><br><span class="line">        function0_.pid <span class="keyword">as</span> pid8_0_0_,</span><br><span class="line">        role2_.name <span class="keyword">as</span> name2_1_1_,</span><br><span class="line">        role2_.code <span class="keyword">as</span> code3_1_1_,</span><br><span class="line">        role2_.description <span class="keyword">as</span> descript4_1_1_,</span><br><span class="line">        user4_.username <span class="keyword">as</span> username2_10_2_,</span><br><span class="line">        user4_.password <span class="keyword">as</span> password3_10_2_,</span><br><span class="line">        user4_.salary <span class="keyword">as</span> salary4_10_2_,</span><br><span class="line">        user4_.birthday <span class="keyword">as</span> birthday5_10_2_,</span><br><span class="line">        user4_.gender <span class="keyword">as</span> gender6_10_2_,</span><br><span class="line">        user4_.station <span class="keyword">as</span> station7_10_2_,</span><br><span class="line">        user4_.telephone <span class="keyword">as</span> telephon8_10_2_,</span><br><span class="line">        user4_.remark <span class="keyword">as</span> remark9_10_2_ </span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        auth_function function0_ </span><br><span class="line">    <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span></span><br><span class="line">        role_function roles1_ </span><br><span class="line">            <span class="keyword">on</span> function0_.id=roles1_.function_id </span><br><span class="line">    <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span></span><br><span class="line">        auth_role role2_ </span><br><span class="line">            <span class="keyword">on</span> roles1_.role_id=role2_.id </span><br><span class="line">    <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span></span><br><span class="line">        user_role users3_ </span><br><span class="line">            <span class="keyword">on</span> role2_.id=users3_.role_id </span><br><span class="line">    <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span></span><br><span class="line">        t_user user4_ </span><br><span class="line">            <span class="keyword">on</span> users3_.user_id=user4_.id </span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        user4_.id=?</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加 Select f 后的查询语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">        function0_.id <span class="keyword">as</span> id1_0_,</span><br><span class="line">        function0_.name <span class="keyword">as</span> name2_0_,</span><br><span class="line">        function0_.code <span class="keyword">as</span> code3_0_,</span><br><span class="line">        function0_.description <span class="keyword">as</span> descript4_0_,</span><br><span class="line">        function0_.page <span class="keyword">as</span> page5_0_,</span><br><span class="line">        function0_.generatemenu <span class="keyword">as</span> generate6_0_,</span><br><span class="line">        function0_.zindex <span class="keyword">as</span> zindex7_0_,</span><br><span class="line">        function0_.pid <span class="keyword">as</span> pid8_0_ </span><br><span class="line">    <span class="keyword">from</span></span><br><span class="line">        auth_function function0_ </span><br><span class="line">    <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span></span><br><span class="line">        role_function roles1_ </span><br><span class="line">            <span class="keyword">on</span> function0_.id=roles1_.function_id </span><br><span class="line">    <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span></span><br><span class="line">        auth_role role2_ </span><br><span class="line">            <span class="keyword">on</span> roles1_.role_id=role2_.id </span><br><span class="line">    <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span></span><br><span class="line">        user_role users3_ </span><br><span class="line">            <span class="keyword">on</span> role2_.id=users3_.role_id </span><br><span class="line">    <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span></span><br><span class="line">        t_user user4_ </span><br><span class="line">            <span class="keyword">on</span> users3_.user_id=user4_.id </span><br><span class="line">    <span class="keyword">where</span></span><br><span class="line">        user4_.id=?</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="用-ehcache-缓存权限数据"><a href="#用-ehcache-缓存权限数据" class="headerlink" title="用 ehcache 缓存权限数据"></a>用 ehcache 缓存权限数据</h5><p>ehcache 是专门的缓存插件，用来缓存 java 对象，提高系统性能</p>
<ul>
<li><p>引入 ehcache 依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引入ehcache的依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sf.ehcache<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ehcache-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>引入 ehcache.xml </p>
<p>maxElementsInMemory：内存存储 java 对象个数</p>
<p>eternal：是否永久有效</p>
<p>timeToIdleSeconds：最大空闲时间<br>timeToLiveSeconds：存活时间，生命周期</p>
<p>overflowToDisk：溢出到磁盘，查询多出来的 java 对象个数存放到磁盘 diskStore path=”java.io.tmpdir” 下</p>
<p>maxElementsOnDisk：磁盘存放最大个数</p>
<p>diskPersistent：tomcat 重启后是否保存磁盘上的数据</p>
<p>diskExpiryThreadIntervalSeconds：线程启动时间</p>
<p>memoryStoreEvictionPolicy：淘汰策略：1.LRU最近利用率最低的优先淘汰; 2.FIFO.先进先出</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ehcache</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">"../config/ehcache.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">diskStore</span> <span class="attr">path</span>=<span class="string">"java.io.tmpdir"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">defaultCache</span></span></span><br><span class="line"><span class="tag">            <span class="attr">maxElementsInMemory</span>=<span class="string">"10000"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">eternal</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">timeToIdleSeconds</span>=<span class="string">"120"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">timeToLiveSeconds</span>=<span class="string">"120"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">overflowToDisk</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">maxElementsOnDisk</span>=<span class="string">"10000000"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">diskPersistent</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">diskExpiryThreadIntervalSeconds</span>=<span class="string">"120"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">memoryStoreEvictionPolicy</span>=<span class="string">"LRU"</span></span></span><br><span class="line"><span class="tag">            /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ehcache</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 spring 配置文件配置缓存管理器，并注入给安全管理器对象</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--注册安全管理器对象--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"securityManager"</span> <span class="attr">class</span>=<span class="string">"org.apache.shiro.web.mgt.DefaultWebSecurityManager"</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--根据 DefaultWebSecurityManager 父类的 setRealm 方法注入--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"realm"</span> <span class="attr">ref</span>=<span class="string">"bosRealm"</span>/&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--注入缓存器--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cacheManager"</span> <span class="attr">ref</span>=<span class="string">"cacheManager"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--注册缓存管理器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"cacheManager"</span> <span class="attr">class</span>=<span class="string">"org.apache.shiro.cache.ehcache.EhCacheManager"</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--注入 ehcache 配置文件--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cacheManagerConfigFile"</span> <span class="attr">value</span>=<span class="string">"classpath:ehcache.xml"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="根据登录用户动态显示系统菜单"><a href="#根据登录用户动态显示系统菜单" class="headerlink" title="根据登录用户动态显示系统菜单"></a>根据登录用户动态显示系统菜单</h5><ul>
<li><p>修改 index.jsp 页面中 ajax 方法的请求地址</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本功能菜单加载</span></span><br><span class="line">$.ajax(&#123;</span><br><span class="line"> url : <span class="string">'$&#123;pageContext.request.contextPath&#125;/FunctionAction_findMenu.action'</span>,</span><br><span class="line"> type : <span class="string">'POST'</span>,</span><br><span class="line"> dataType : <span class="string">'text'</span>,</span><br><span class="line"> success : <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> zNodes = <span class="built_in">eval</span>(<span class="string">"("</span> + data + <span class="string">")"</span>);</span><br><span class="line">  $.fn.zTree.init($(<span class="string">"#treeMenu"</span>), setting, zNodes);</span><br><span class="line"> &#125;,</span><br><span class="line"> error : <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">  alert(<span class="string">'菜单加载异常!'</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>action</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据当前登录用户查询对应菜单数据，并返回 json</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">findMenu</span><span class="params">()</span></span>&#123;</span><br><span class="line">    List&lt;Function&gt; list = functionService.findMenu();</span><br><span class="line">    <span class="keyword">this</span>.java2Json(list,<span class="keyword">new</span> String[]&#123;<span class="string">"parentFunction"</span>,<span class="string">"roles"</span>,<span class="string">"children"</span>&#125;);</span><br><span class="line">    <span class="keyword">return</span> NONE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据当前登录用户查询对应菜单数据，并返回 json</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Function&gt; <span class="title">findMenu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = BOSUtils.getLoginUser();</span><br><span class="line">        List&lt;Function&gt; list = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(user.getUsername().equals(<span class="string">"admin"</span>))&#123;</span><br><span class="line">            <span class="comment">//如果是超级管理员则返回所有菜单</span></span><br><span class="line">            list = functionDao.findAllMenu();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line"><span class="comment">//            根据用户查询菜单</span></span><br><span class="line">            list = functionDao.findMenuByUserId(user.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>dao</p>
<p>DESC 是descend 降序<br>asc 是ascend 升序</p>
<p>ORDER BY xxx DESC :根据 xxx 字段逆序排序，默认升序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有菜单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Function&gt; <span class="title">findAllMenu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String hql = <span class="string">"FROM Function f WHERE f.generatemenu = '1' ORDER BY f.zindex DESC"</span>;</span><br><span class="line">        List&lt;Function&gt; list = (List&lt;Function&gt;) <span class="keyword">this</span>.getHibernateTemplate().find(hql);</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据用户 id 查询菜单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Function&gt; <span class="title">findMenuByUserId</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        String hql = <span class="string">" SELECT DISTINCT f FROM Function f LEFT JOIN f.roles r LEFT JOIN r.users u WHERE u.id=? "</span> +</span><br><span class="line">                <span class="string">" AND f.generatemenu = '1' ORDER BY f.zindex DESC "</span>;</span><br><span class="line">        List&lt;Function&gt; list = (List&lt;Function&gt;) <span class="keyword">this</span>.getHibernateTemplate().find(hql,id);</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>domian 添加 json 返回</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getpId</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(parentFunction==<span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"0"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> parentFunction.getId();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="使用-quartz-与-javaMail-定时发送邮件"><a href="#使用-quartz-与-javaMail-定时发送邮件" class="headerlink" title="使用 quartz 与 javaMail 定时发送邮件"></a>使用 quartz 与 javaMail 定时发送邮件</h5><ul>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入 quartz 对应依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.quartz-scheduler<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.quartz-scheduler<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>quartz-jobs<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--引入 javaMail 依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.mail<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>提供一个作业类，为系统管理员发送邮件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送邮件的作业</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhaoqx</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailJob</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Resource</span></span><br><span class="line">   <span class="keyword">private</span> IWorkbillDao workbillDao;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> String username;<span class="comment">//发件人邮箱账号</span></span><br><span class="line">   <span class="keyword">private</span> String password;<span class="comment">//密码</span></span><br><span class="line">   <span class="keyword">private</span> String smtpServer;<span class="comment">//服务器</span></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> username;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.username = username;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> password;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.password = password;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">"要发邮件了。。。"</span> + <span class="keyword">new</span> Date());</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">//查询工单类型为新单的所有工单</span></span><br><span class="line">         List&lt;Workbill&gt; list = workbillDao.findAll();</span><br><span class="line">         <span class="keyword">if</span>(<span class="keyword">null</span> != list &amp;&amp; list.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">final</span> Properties mailProps = <span class="keyword">new</span> Properties();</span><br><span class="line">            mailProps.put(<span class="string">"mail.smtp.host"</span>, <span class="keyword">this</span>.getSmtpServer());</span><br><span class="line">            mailProps.put(<span class="string">"mail.smtp.auth"</span>, <span class="string">"true"</span>);</span><br><span class="line">            mailProps.put(<span class="string">"mail.username"</span>, <span class="keyword">this</span>.getUsername());</span><br><span class="line">            mailProps.put(<span class="string">"mail.password"</span>, <span class="keyword">this</span>.getPassword());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 构建授权信息，用于进行SMTP进行身份验证</span></span><br><span class="line">            Authenticator authenticator = <span class="keyword">new</span> Authenticator() &#123;</span><br><span class="line">               <span class="function"><span class="keyword">protected</span> PasswordAuthentication <span class="title">getPasswordAuthentication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                  <span class="comment">// 用户名、密码</span></span><br><span class="line">                  String userName = mailProps.getProperty(<span class="string">"mail.username"</span>);</span><br><span class="line">                  String password = mailProps.getProperty(<span class="string">"mail.password"</span>);</span><br><span class="line">                  <span class="keyword">return</span> <span class="keyword">new</span> PasswordAuthentication(userName, password);</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">// 使用环境属性和授权信息，创建邮件会话</span></span><br><span class="line">            Session mailSession = Session.getInstance(mailProps, authenticator);</span><br><span class="line">            <span class="keyword">for</span>(Workbill workbill : list)&#123;</span><br><span class="line">               <span class="comment">// 创建邮件消息</span></span><br><span class="line">               MimeMessage message = <span class="keyword">new</span> MimeMessage(mailSession);</span><br><span class="line">               <span class="comment">// 设置发件人</span></span><br><span class="line">               InternetAddress from = <span class="keyword">new</span> InternetAddress(mailProps.getProperty(<span class="string">"mail.username"</span>));</span><br><span class="line">               message.setFrom(from);</span><br><span class="line">               <span class="comment">// 设置收件人</span></span><br><span class="line">               InternetAddress to = <span class="keyword">new</span> InternetAddress(<span class="string">"test@itcast.cn"</span>);</span><br><span class="line">               message.setRecipient(RecipientType.TO, to);</span><br><span class="line">               <span class="comment">// 设置邮件标题</span></span><br><span class="line">               message.setSubject(<span class="string">"系统邮件：新单通知"</span>);</span><br><span class="line">               <span class="comment">// 设置邮件的内容体</span></span><br><span class="line">               message.setContent(workbill.toString(), <span class="string">"text/html;charset=UTF-8"</span>);</span><br><span class="line">               <span class="comment">// 发送邮件</span></span><br><span class="line">               Transport.send(message);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">         ex.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getSmtpServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> smtpServer;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSmtpServer</span><span class="params">(String smtpServer)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.smtpServer = smtpServer;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 spring bean</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 注册自定义作业类,注入邮箱账号密码及属性 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"myJob"</span> <span class="attr">class</span>=<span class="string">"com.itheima.bos.jobs.MailJob"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"crowsong@126.com"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"63509363"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"smtpServer"</span> <span class="attr">value</span>=<span class="string">"smtp.126.com"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 配置JobDetail --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jobDetail"</span> <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean"</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 注入目标对象 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"targetObject"</span> <span class="attr">ref</span>=<span class="string">"myJob"</span>/&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 注入目标方法 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"targetMethod"</span> <span class="attr">value</span>=<span class="string">"execute"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 配置触发器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"myTrigger"</span> <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.quartz.CronTriggerFactoryBean"</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 注入任务详情对象 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobDetail"</span> <span class="attr">ref</span>=<span class="string">"jobDetail"</span>/&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 注入cron表达式，通过这个表达式指定触发的时间点 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cronExpression"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span>&gt;</span>0/5 * * * * ?<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 配置调度工厂 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"schedulerFactoryBean"</span> <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.quartz.SchedulerFactoryBean"</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 注入触发器 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"triggers"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"myTrigger"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h5 id="Highcharts"><a href="#Highcharts" class="headerlink" title="Highcharts"></a>Highcharts</h5><p>基于 jQuery 开发的一个图形报表工具插件</p>
<p>纯 javascript 编写的一个图标库，不需要 flash java 可以运行</p>
<p>在项目中展示区域分布图</p>
<ul>
<li><p>在 subarea.jsp 中引入 资源文件 .js</p>
</li>
<li><p>添加显示图表按钮,并提供一个 div 窗口</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 图表分区</span></span><br><span class="line">$(<span class="string">'#showSubareaWindow'</span>).window(&#123;</span><br><span class="line">    width: <span class="number">600</span>,</span><br><span class="line">    modal: <span class="literal">true</span>,</span><br><span class="line">    shadow: <span class="literal">true</span>,</span><br><span class="line">    closed: <span class="literal">true</span>,</span><br><span class="line">    height: <span class="number">400</span>,</span><br><span class="line">    resizable: <span class="literal">false</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义 function</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 显示饼状图</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doShowHighcharts</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">"#showSubareaWindow"</span>).window(<span class="string">"open"</span>);</span><br><span class="line">    $.post(<span class="string">'SubareaAction_findSubareasGroupByProvince.action'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        $(<span class="string">'#test'</span>).highcharts(&#123;</span><br><span class="line">            title: &#123;</span><br><span class="line">                text: <span class="string">'区域分区分布图'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            series: [&#123;</span><br><span class="line">                type: <span class="string">'pie'</span>,</span><br><span class="line">                name: <span class="string">'区域分区分布图'</span>,</span><br><span class="line">                data: data</span><br><span class="line">            &#125;]</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>在服务端提供方法</p>
<p>action，service</p>
<p>dao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">findSubareasGroupByProvince</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String hql = <span class="string">"SELECT r.province,count(*) FROM Subarea s LEFT JOIN s.region r GROUP BY r.province"</span>;</span><br><span class="line">    <span class="keyword">return</span> (List&lt;Object&gt;) <span class="keyword">this</span>.getHibernateTemplate().find(hql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="在-Linux-下部署应用"><a href="#在-Linux-下部署应用" class="headerlink" title="在 Linux 下部署应用"></a>在 Linux 下部署应用</h4><ul>
<li><p>Linux 的 mysql 下创建表，并创建一个用户，给他权限</p>
<p>创建表：<code>create database bos32 character set utf8;</code></p>
<p>创建用户密码：<code>create user joker identified by &#39;1234&#39;;</code></p>
<p>给用户操作表的所有权限：<code>grant all on bos32.* to joker;</code></p>
</li>
<li><p>查询数据库的用户</p>
<p><code>showdatabases;</code>：查看所有的数据库名称</p>
<p><code>use mysql;</code>：使用 mysql 库</p>
<p><code>show tables;</code>：查看 mysql 库的所有表，可以看到 mysql 中有 user 项</p>
<p><code>desc user;</code>：查看 user 数据表结构，跟 <code>show columns from user;</code> 效果相同</p>
<p><code>select host,user from user</code> ：查看 user 表中的 host 与 user 属性值</p>
<p>host 为 % 表示必须指定连接的 ip 地址（用于远程连接），即使是本地连接的也要指定；host 为 localhost 用于本地连接</p>
<p><a href="http://c.biancheng.net/cpp/html/1450.html" target="_blank" rel="noopener">desc 用法</a></p>
</li>
<li><p>mysql 连接到 Linux 服务器</p>
<p>导入 bos 项目的表</p>
</li>
<li><p>改变数据库访问地址，使用 idea 导出项目 war 包</p>
<p><code>whereis tomcat</code> 查看软件安装路径，将 war 包导入到 tomcat 的 webapps 路径下</p>
</li>
<li><p>在 tomcat/logs 目录下 <code>tail -f catalina.out</code> 打开日志记录文件，查看动态日志</p>
<p>在 tomcat/bin 目录下 <code>sh startup.sh</code> 开启 tomcat</p>
<p>tomcat 报错端口被占用，jps 查看已启动的服务</p>
<p>[root@localhost bin]# jps<br>2818 Bootstrap<br>4516 Bootstrap</p>
<p>全部 kill 掉</p>
<p>[root@localhost bin]# kill -9 2818<br>[root@localhost bin]# kill -9 4516</p>
<p>再次重启 tomcat</p>
<p>访问地址 linux ip:8080/发布项目文件夹名/</p>
<p>192.168.171.128:8080/bos-web-1.0-SNAPSHOT/</p>
<p>访问出错的可能是 Linux 的 tomcat 、jdk 版本与 idea 的不一致</p>
</li>
</ul>
<hr>
<p>freemark 模板技术</p>
<p>codemachine 代码生成器，提供静态代码模板，将数据放入模板生成静态页面，用来生成重复量大的静态页面</p>
<p><em>ExtJS</em>是一个纯粹的JavaScript应用程序框架（英语：application framework），用于使用Ajax、DHTML和DOM脚本构建交互式跨平台网络应用程序。</p>
<p>POI 导出 Execel 文件</p>
<p>IText 导出 PDF 文件</p>
<hr>
<h4 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h4><h5 id="Q-数据库查询错误"><a href="#Q-数据库查询错误" class="headerlink" title="Q: 数据库查询错误"></a>Q: 数据库查询错误</h5><p>Could not open JDBC Connection for transaction; nested exception is java.sql.SQLException: No suitable driver found for jdbc:mysql///crm</p>
<p>A: jdbc:mysql 后没加 :</p>
<hr>
<h5 id="Q-SQL-查询错误"><a href="#Q-SQL-查询错误" class="headerlink" title="Q: SQL 查询错误"></a>Q: SQL 查询错误</h5><p>StatementCallback; bad SQL grammar [select * from t_customer]; nested exception is java.sql.SQLException: Column ‘telphone’ not found</p>
<p>A: bean 中字段错误，tel + e + phone</p>
<hr>
<h5 id="Q：SQL-查询错误，显示全为-not-defined-null"><a href="#Q：SQL-查询错误，显示全为-not-defined-null" class="headerlink" title="Q：SQL 查询错误，显示全为 not defined null"></a>Q：SQL 查询错误，显示全为 not defined null</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String sql = <span class="string">"select * from t_customer where decidedzone_id = ?;"</span>;</span><br></pre></td></tr></table></figure>
<p>将 id=? 写成了 id is ?,查询错误</p>
<hr>
<h5 id="Q-表单提交数据错误"><a href="#Q-表单提交数据错误" class="headerlink" title="Q:表单提交数据错误"></a>Q:表单提交数据错误</h5><p>customerIds: 小黑(13722222222)</p>
<p>\A: &lt;select>\&lt;option value=’”+id+”‘>“+name+”\&lt;/option>\&lt;/select> </p>
<p>中的值 value 是表单会提交的参数</p>
<p>如果将 value 写作 id，那么表单会提交 name 所在位置的值</p>
<hr>
<h5 id="Q-hibernate-查询数据库错误"><a href="#Q-hibernate-查询数据库错误" class="headerlink" title="Q: hibernate 查询数据库错误"></a>Q: hibernate 查询数据库错误</h5><p>Caused by: org.apache.cxf.binding.soap.SoapFault: PreparedStatementCallback; SQL [update t_customer set decidedzone_id = null where decidedzone_id = 12;]; Parameter index out of range (1 &gt; number of parameters, which is 0).; nested exception is java.sql.SQLException: Parameter index out of range (1 &gt; number of parameters, which is 0)</p>
<p>A：You will get this error when you call any of the <code>setXxx()</code> methods on <code>PreparedStatement</code>, while the SQL query string does not have any placeholders <code>?</code> for this.</p>
<p>大意是准备的 sql 语句中 ？ 占位符数与传入参数数量 不匹配</p>
<hr>
<h5 id="Q-录入信息时，只有某几个值无法录入"><a href="#Q-录入信息时，只有某几个值无法录入" class="headerlink" title="Q: 录入信息时，只有某几个值无法录入"></a>Q: 录入信息时，只有某几个值无法录入</h5><p>A：idea 逆向工程生成 hbm.xml 文件时，没有将这几个值正确设置为 多对一的外键，导致无法录入</p>
<hr>
<h5 id="Q-创建数据库时无法将一个表外键关联到另一个表的主键上"><a href="#Q-创建数据库时无法将一个表外键关联到另一个表的主键上" class="headerlink" title="Q:创建数据库时无法将一个表外键关联到另一个表的主键上"></a>Q:创建数据库时无法将一个表外键关联到另一个表的主键上</h5><p>MySQL error 1452 - Cannot add or update a child row: a foreign key constraint fails</p>
<p>将一个表外键关联到另一表主键时一直报错，经搜索发现是子表外键所要关联的其他表主键数据不存在，或者是两张表的属性不都是 InoDB，但都不是我的问题所在。</p>
<p>最后终于找到了一个方法:将子表的外键所在字段删除，重新创建，即可关联上其他表的主键</p>
<ol>
<li>删除要成为外键的列。</li>
<li>再次创建它，但将其默认值设置为NULL。</li>
<li>尝试再次将其设置为外键。</li>
</ol>
<blockquote>
<p>参考：<a href="https://cloud.tencent.com/developer/ask/60529" target="_blank" rel="noopener">https://cloud.tencent.com/developer/ask/60529</a> 第一条回答</p>
</blockquote>
<hr>
<h5 id="Q：TOMCAT-严重-Error-filterStart"><a href="#Q：TOMCAT-严重-Error-filterStart" class="headerlink" title="Q：TOMCAT 严重: Error filterStart"></a>Q：TOMCAT 严重: Error filterStart</h5><p>启动 tomcat 过滤器错误</p>
<p>A:1、试着把tomat/server/lib目录下的commons-digester.jar,commons-beanutils.jar拷贝到common/lib/目录  －－经测试不行<br>2、里有个文章说tomcat里的bug,没有实现javax.servlet.Filter的Filter会报这样的错误，看来tomcat在启动就初始化Filter实例，但是在filter中又没有看到那段代码没有实现Filter，或者有代码在启动时没有实例化。－－没发现问题。</p>
<p>3、web.xml 初始化参数少了</p>
<p>自己的解决问题：注册安全管理器对象错误。少写了一个 web</p>
<p>正确：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"securityManager"</span> <span class="attr">class</span>=<span class="string">"org.apache.shiro.web.mgt.DefaultWebSecurityManager"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>错误：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"securityManager"</span> <span class="attr">class</span>=<span class="string">"org.apache.shiro.mgt.DefaultSecurityManager"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>参考：<a href="http://www.blogjava.net/skyful/archive/2007/03/13/103605.html" target="_blank" rel="noopener">TOMCAT 严重: Error filterStart</a></p>
</blockquote>
<hr>
<h5 id="Q-嵌套错误"><a href="#Q-嵌套错误" class="headerlink" title="Q:嵌套错误"></a>Q:嵌套错误</h5><p>org.springframework.beans.factory.BeanCreationException: Error creating bean with name ‘shiroFilter’ defined in class path resource [applicationContext.xml]: Cannot resolve reference to bean ‘securityManager’ while setting bean property ‘securityManager’; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name ‘securityManager’ defined in class path resource [applicationContext.xml]: Cannot resolve reference to bean ‘bosRealm’ while setting bean property ‘realm’; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name ‘bosRealm’: Injection of autowired dependencies failed; nested exception is org.springframework.beans.factory.BeanCreationException: Could not autowire field: private com.itheima.bos.dao.IUserDao com.itheima.bos.realm.BOSRealm.userDao; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name ‘userDaoImpl’: Injection of resource dependencies failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name ‘sessionFactory’ defined in class path resource [applicationContext.xml]: Invocation of init method failed; nested exception is org.hibernate.MappingException: An association from the table user_role refers to an unmapped class: com.itheima.bos.reverse.User</p>
<p>A: 因为复制过来的 Role.hbm.xml 错误引用了另一个文件夹的 User 导致加载失败</p>
<hr>
<h5 id="Q-hibernate-实体错误"><a href="#Q-hibernate-实体错误" class="headerlink" title="Q: hibernate 实体错误"></a>Q: hibernate 实体错误</h5><ol>
<li>Unknown entity: com.itheima.bos.domain.Function</li>
<li>Unknown entity: com.itheima.bos.domain.Function; nested exception is org.hibernate.MappingException: Unknown entity: com.itheima.bos.domain.Function</li>
</ol>
<p>Q: bean 复制时没有将 hbm.xml 中的路径修改</p>
<hr>
<h5 id="Q：easyui-的-combotree-下拉列表有结构，但数据为空"><a href="#Q：easyui-的-combotree-下拉列表有结构，但数据为空" class="headerlink" title="Q：easyui 的 combotree 下拉列表有结构，但数据为空"></a>Q：easyui 的 combotree 下拉列表有结构，但数据为空</h5><p>A：combotree 需要的字段是 id 跟 text，自己返回的 json 数据只有数据库里有的字段类型，所以需要添加一个 text 字段进 json</p>
<p>在需要添加的 bean 中加入 get 方法 ,返回需要的属性值，此时 json 就会多一个 “text”: “name” 的字段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在转换 json 时加入一个 text 字段</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getText</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//text 等于那个属性的值</span></span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以参考的其他方法：</p>
<p><a href="https://blog.csdn.net/a151605/article/details/80207521" target="_blank" rel="noopener">使用easyui comboTree加载菜单时,后台字段和规定字段不一致无法加载问题</a></p>
</blockquote>
<hr>
<h5 id="Q：tomcat-启动报错-hibernate-错误"><a href="#Q：tomcat-启动报错-hibernate-错误" class="headerlink" title="Q：tomcat 启动报错 hibernate 错误"></a>Q：tomcat 启动报错 hibernate 错误</h5><p>nested exception is org.hibernate.boot.InvalidMappingException: Could not parse mapping document: null (INPUT_STREAM)</p>
<p>一连串的 nested </p>
<p>A：经过查询应该是映射文件错误，修改 hbm.xml 文件中的错误即可</p>
<hr>
<h5 id="Q-Unknown-entity-异常"><a href="#Q-Unknown-entity-异常" class="headerlink" title="Q: Unknown entity 异常"></a>Q: Unknown entity 异常</h5><p>nested exception is org.hibernate.boot.InvalidMappingException: Could not parse mapping document: null (INPUT_STREAM)</p>
<p>A：又是一个 hbm.xml 移动文件夹位置后没有修改其中路径的问题</p>
<hr>
<h5 id="Q：空指针异常"><a href="#Q：空指针异常" class="headerlink" title="Q：空指针异常"></a>Q：空指针异常</h5><p>java.lang.NullPointerException</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">com.itheima.bos.service.impl.RoleServiceImpl.save(RoleServiceImpl.java:31)</span><br><span class="line">sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br></pre></td></tr></table></figure>
<p>A:需要在调用 Functions 前先创建 Set 集合</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.getFunctions().add(function);</span><br></pre></td></tr></table></figure>
<p>或者直接在 Function Bean 中直接创建好 Set</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private Set&lt;Function&gt; functions = new HashSet(0);//当前角色对应的多个权限</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="Q：保存角色后只执行了一个-insert"><a href="#Q：保存角色后只执行了一个-insert" class="headerlink" title="Q：保存角色后只执行了一个 insert"></a>Q：保存角色后只执行了一个 insert</h5><p>A：model 中存放的 Role 实体类的 hbm.xml 文件中，添加了 inverse=“true” ,表示反转，放弃维护外键，从而无法添加外键 Function</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">set</span> <span class="attr">name</span>=<span class="string">"functions"</span> /**<span class="attr">inverse</span>=<span class="string">"true"</span>**/ <span class="attr">table</span>=<span class="string">"role_function"</span> <span class="attr">schema</span>=<span class="string">"bos32"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">"role_id"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">many-to-many</span> <span class="attr">not-found</span>=<span class="string">"ignore"</span> <span class="attr">class</span>=<span class="string">"com.itheima.bos.domain.Function"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">"function_id"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">many-to-many</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//角色关联，持久状态对象能关联托管状态，不能关联瞬时状态,</span></span><br><span class="line"><span class="comment">//如果 Role.hbm.xml 中设置了 inverse="true" 则不能让角色关联权限了(放弃维护关系)</span></span><br><span class="line">model.getFunctions().add(function);</span><br></pre></td></tr></table></figure>
<hr>
<h5 id="Q-java-lang-reflect-InvocationTargetException"><a href="#Q-java-lang-reflect-InvocationTargetException" class="headerlink" title="Q:java.lang.reflect.InvocationTargetException"></a>Q:java.lang.reflect.InvocationTargetException</h5><p>A：json 转换 Date 会出现问题</p>
<p>方案一：不使用 Date 转换，将 birthday 排除转换，并使用 birthdayString，在页面也使用此属性接受</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java2Json(pageBean,<span class="keyword">new</span> String[]&#123;<span class="string">"noticebills"</span>,<span class="string">"roles"</span>,<span class="string">"birthday"</span>&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getBirthdayString</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(birthday!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        String format = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>).format(birthday);</span><br><span class="line">        <span class="keyword">return</span> format;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"暂无数据"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>或者其他方式（未尝试）</p>
<p><a href="https://blog.csdn.net/ye1992/article/details/17436765" target="_blank" rel="noopener">https://blog.csdn.net/ye1992/article/details/17436765</a></p>
</blockquote>
<hr>
<h5 id="Q-使用-ehcache-缓存后会出现异常-java-io-NotSerializableException"><a href="#Q-使用-ehcache-缓存后会出现异常-java-io-NotSerializableException" class="headerlink" title="Q:使用 ehcache 缓存后会出现异常 java.io.NotSerializableException"></a>Q:使用 ehcache 缓存后会出现异常 java.io.NotSerializableException</h5><p>A:对于需要缓存的类需要加上 Serializable 接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br></pre></td></tr></table></figure>
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        
          
        
        <div class="post-tags">
          
            <a href="/tags/java/" rel="tag"># java</a>
          
            <a href="/tags/web/" rel="tag"># web</a>
          
            <a href="/tags/ssh/" rel="tag"># ssh</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/02/14/bos/" rel="next" title="BOS_former">
                <i class="fa fa-chevron-left"></i> BOS_former
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/02/25/interview/" rel="prev" title="interview">
                interview <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/shuvi.gif"
                alt="crowsong"/>
            
              <p class="site-author-name" itemprop="name">crowsong</p>
              <div class="site-description motion-element" itemprop="description">日々私たちが过ごしている日常は、実は、奇迹の连続なのかもしれない</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">40</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">43</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/crow-song" title="GitHub &rarr; https://github.com/crow-song" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="/crowsong.end@gmail.com" title="E-Mail &rarr; crowsong.end@gmail.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#定区关联客户"><span class="nav-number">1.</span> <span class="nav-text">定区关联客户</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#在-BOS-中配置代理对象远程调用-crm"><span class="nav-number">1.1.</span> <span class="nav-text">在 BOS 中配置代理对象远程调用 crm</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#关联客户绑定事件函数"><span class="nav-number">1.2.</span> <span class="nav-text">关联客户绑定事件函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#给-crm-服务端扩展定区关联客户方法"><span class="nav-number">1.3.</span> <span class="nav-text">给 crm 服务端扩展定区关联客户方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查看分区中关联的方法"><span class="nav-number">1.4.</span> <span class="nav-text">查看分区中关联的方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#业务受理需求"><span class="nav-number">1.5.</span> <span class="nav-text">业务受理需求</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#业务受理自动分单"><span class="nav-number">1.6.</span> <span class="nav-text">业务受理自动分单</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#权限控制"><span class="nav-number">1.7.</span> <span class="nav-text">权限控制</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#shiro-框架"><span class="nav-number">2.</span> <span class="nav-text">shiro 框架</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#使用-shiro-的方法注解方式权限控制"><span class="nav-number">2.1.</span> <span class="nav-text">使用 shiro 的方法注解方式权限控制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用-shiro-的页面标签方式控制权限"><span class="nav-number">2.2.</span> <span class="nav-text">使用 shiro 的页面标签方式控制权限</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#权限数据管理"><span class="nav-number">2.3.</span> <span class="nav-text">权限数据管理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使下拉框变为层级格式"><span class="nav-number">2.4.</span> <span class="nav-text">使下拉框变为层级格式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#添加角色功能"><span class="nav-number">2.5.</span> <span class="nav-text">添加角色功能</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#用户管理"><span class="nav-number">2.6.</span> <span class="nav-text">用户管理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#修改-Realm-中授权方法（查询数据库获得用户权限）"><span class="nav-number">2.7.</span> <span class="nav-text">修改 Realm 中授权方法（查询数据库获得用户权限）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#用-ehcache-缓存权限数据"><span class="nav-number">2.8.</span> <span class="nav-text">用 ehcache 缓存权限数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#根据登录用户动态显示系统菜单"><span class="nav-number">2.9.</span> <span class="nav-text">根据登录用户动态显示系统菜单</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用-quartz-与-javaMail-定时发送邮件"><span class="nav-number">2.10.</span> <span class="nav-text">使用 quartz 与 javaMail 定时发送邮件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Highcharts"><span class="nav-number">2.11.</span> <span class="nav-text">Highcharts</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在-Linux-下部署应用"><span class="nav-number">3.</span> <span class="nav-text">在 Linux 下部署应用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Q-amp-A"><span class="nav-number">4.</span> <span class="nav-text">Q&amp;A</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Q-数据库查询错误"><span class="nav-number">4.1.</span> <span class="nav-text">Q: 数据库查询错误</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Q-SQL-查询错误"><span class="nav-number">4.2.</span> <span class="nav-text">Q: SQL 查询错误</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Q：SQL-查询错误，显示全为-not-defined-null"><span class="nav-number">4.3.</span> <span class="nav-text">Q：SQL 查询错误，显示全为 not defined null</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Q-表单提交数据错误"><span class="nav-number">4.4.</span> <span class="nav-text">Q:表单提交数据错误</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Q-hibernate-查询数据库错误"><span class="nav-number">4.5.</span> <span class="nav-text">Q: hibernate 查询数据库错误</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Q-录入信息时，只有某几个值无法录入"><span class="nav-number">4.6.</span> <span class="nav-text">Q: 录入信息时，只有某几个值无法录入</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Q-创建数据库时无法将一个表外键关联到另一个表的主键上"><span class="nav-number">4.7.</span> <span class="nav-text">Q:创建数据库时无法将一个表外键关联到另一个表的主键上</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Q：TOMCAT-严重-Error-filterStart"><span class="nav-number">4.8.</span> <span class="nav-text">Q：TOMCAT 严重: Error filterStart</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Q-嵌套错误"><span class="nav-number">4.9.</span> <span class="nav-text">Q:嵌套错误</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Q-hibernate-实体错误"><span class="nav-number">4.10.</span> <span class="nav-text">Q: hibernate 实体错误</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Q：easyui-的-combotree-下拉列表有结构，但数据为空"><span class="nav-number">4.11.</span> <span class="nav-text">Q：easyui 的 combotree 下拉列表有结构，但数据为空</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Q：tomcat-启动报错-hibernate-错误"><span class="nav-number">4.12.</span> <span class="nav-text">Q：tomcat 启动报错 hibernate 错误</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Q-Unknown-entity-异常"><span class="nav-number">4.13.</span> <span class="nav-text">Q: Unknown entity 异常</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Q：空指针异常"><span class="nav-number">4.14.</span> <span class="nav-text">Q：空指针异常</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Q：保存角色后只执行了一个-insert"><span class="nav-number">4.15.</span> <span class="nav-text">Q：保存角色后只执行了一个 insert</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Q-java-lang-reflect-InvocationTargetException"><span class="nav-number">4.16.</span> <span class="nav-text">Q:java.lang.reflect.InvocationTargetException</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Q-使用-ehcache-缓存后会出现异常-java-io-NotSerializableException"><span class="nav-number">4.17.</span> <span class="nav-text">Q:使用 ehcache 缓存后会出现异常 java.io.NotSerializableException</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">crowsong</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.2.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/affix.js?v=7.2.0"></script>

  <script src="/js/schemes/pisces.js?v=7.2.0"></script>



  
  <script src="/js/scrollspy.js?v=7.2.0"></script>
<script src="/js/post-details.js?v=7.2.0"></script>



  


  <script src="/js/next-boot.js?v=7.2.0"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":120,"height":240},"mobile":{"show":false},"log":false});</script></body>
</html>
